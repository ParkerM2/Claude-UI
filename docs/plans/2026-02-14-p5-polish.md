# P5 Polish — Full Implementation Plan

**Status**: APPROVED
**Author**: Claude (Team Lead)
**Created**: 2026-02-14
**Priority**: MEDIUM
**Base Branch**: master
**Feature Branch**: feature/p5-polish
**Source**: docs/plans/2026-02-13-full-codebase-audit.md (items 31-37)

---

## Executive Summary

P5 is the final polish pass before the app is considered feature-complete. It covers 7 items across UI gaps, dead code cleanup, infrastructure hardening, and system integration. The scope ranges from 30-minute deletions to multi-hour service wiring.

**Goal**: After P5, every button does something, every screen is reachable, every service is wired end-to-end, and there's zero dead code. The user should only need API keys saved and Claude authorized — everything else should "just work."

**Total estimated effort**: ~20-25 hours across 7 items
**Parallelization**: Items 36+37 (cleanup), 31+33 (UI), 32+34 (wiring) can run in parallel

---

## Item 31: Global Hub Connection Indicator

### Problem
Hub connection status is only visible on the Settings page. Users have no persistent visual indicator of whether they're connected to the Hub server.

### Current State
- `hub-connection.ts` tracks status: `connected | disconnected | connecting | error`
- `event:hub.connectionChanged` is emitted on status changes
- `HubNotification.tsx` shows temporary toast notifications (auto-dismisses after 4s)
- Sidebar footer has a Settings button but no status indicator

### Implementation

**Create**: `src/renderer/shared/components/HubConnectionIndicator.tsx`
- Small dot indicator component: green (connected), yellow (connecting), red (error), gray (disconnected)
- Tooltip showing connection details (Hub URL, status text)
- Listens to `event:hub.connectionChanged` via `useIpcEvent`
- Fetch initial status via existing `hub.getStatus` IPC channel
- Click navigates to Hub Settings

**Modify**: `src/renderer/app/layouts/Sidebar.tsx`
- Add `HubConnectionIndicator` next to the Settings button in the sidebar footer
- Show only the dot when sidebar is collapsed, dot + "Hub" label when expanded

**Modify**: `src/shared/ipc-contract.ts`
- Verify `hub.getStatus` channel exists (it should — if not, add it)

### Acceptance Criteria
- [ ] Green dot visible in sidebar when Hub is connected
- [ ] Gray dot when not configured/disconnected
- [ ] Yellow dot when connecting
- [ ] Red dot when connection error
- [ ] Tooltip shows status text on hover
- [ ] Click navigates to Settings > Hub section
- [ ] Works in both expanded and collapsed sidebar modes
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run lint` passes

### Files
| Action | Path |
|--------|------|
| CREATE | `src/renderer/shared/components/HubConnectionIndicator.tsx` |
| MODIFY | `src/renderer/app/layouts/Sidebar.tsx` |
| MODIFY | `src/shared/ipc-contract.ts` (only if `hub.getStatus` missing) |

---

## Item 32: Configurable Hotkeys UI

### Problem
Global hotkeys are hardcoded in `hotkey-manager.ts`. The `HotkeySettings.tsx` component exists with a full edit UI, but it's not rendered in SettingsPage and has no backend persistence or re-registration logic.

### Current State
- `hotkey-manager.ts` has hardcoded `DEFAULT_HOTKEYS` (quickCommand, quickNote, quickTask)
- `HotkeySettings.tsx` has full edit/save UI but:
  - Uses local `useState` only — not persisted to disk
  - Calls `updateSettings.mutate({ hotkeys: ... })` but `AppSettings` has no `hotkeys` field
  - Not imported or rendered in `SettingsPage.tsx`
- `settings-service.ts` has no logic for hotkey persistence
- No IPC channels for hotkey read/update/re-registration

### Implementation

**Modify**: `src/shared/types/settings.ts`
- Add `hotkeys?: Record<string, string>` field to `AppSettings`

**Modify**: `src/shared/ipc-contract.ts`
- Add `hotkeys.get` channel: returns current hotkey bindings
- Add `hotkeys.update` channel: accepts partial hotkey map, persists and re-registers
- Add `hotkeys.reset` channel: resets to defaults and re-registers

**Create**: `src/main/ipc/handlers/hotkey-handlers.ts`
- `hotkeys.get` → reads from settings service (falls back to defaults)
- `hotkeys.update` → saves to settings, calls hotkey manager to unregister + re-register
- `hotkeys.reset` → clears custom hotkeys, re-registers defaults

**Modify**: `src/main/tray/hotkey-manager.ts`
- Add `registerFromConfig(config: Record<string, string>)` method
- Reads hotkey config, maps action names to callbacks
- Unregisters existing, registers new
- Keep `registerDefaults()` as fallback

**Modify**: `src/main/index.ts`
- After creating hotkey manager, check settings for custom hotkeys
- If custom exist, call `registerFromConfig()`; else `registerDefaults()`
- Register hotkey IPC handlers

**Modify**: `src/renderer/features/settings/components/HotkeySettings.tsx`
- Load initial hotkey values from `hotkeys.get` IPC channel (not local state)
- Save calls `hotkeys.update` IPC channel
- Show success/error feedback after save
- Add "Reset to Defaults" button calling `hotkeys.reset`

**Modify**: `src/renderer/features/settings/components/SettingsPage.tsx`
- Import and render `<HotkeySettings />` section between Webhooks and About

### Acceptance Criteria
- [ ] HotkeySettings section visible in Settings page
- [ ] Current bindings loaded from persisted settings on page load
- [ ] Editing a binding + saving persists to disk AND re-registers the hotkey globally
- [ ] Reset to Defaults restores original bindings and re-registers
- [ ] Invalid accelerator format shows error feedback
- [ ] Hotkeys survive app restart (persistence verified)
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run lint` passes

### Files
| Action | Path |
|--------|------|
| CREATE | `src/main/ipc/handlers/hotkey-handlers.ts` |
| MODIFY | `src/shared/types/settings.ts` |
| MODIFY | `src/shared/ipc-contract.ts` |
| MODIFY | `src/main/tray/hotkey-manager.ts` |
| MODIFY | `src/main/index.ts` |
| MODIFY | `src/main/ipc/index.ts` |
| MODIFY | `src/renderer/features/settings/components/HotkeySettings.tsx` |
| MODIFY | `src/renderer/features/settings/components/SettingsPage.tsx` |

---

## Item 33: App Launch at System Startup

### Problem
No option to launch the app at system startup. `BackgroundSettings.tsx` exists with tray/background toggles but has no startup toggle and isn't rendered in SettingsPage.

### Current State
- `BackgroundSettings.tsx` has 3 toggles (minimize to tray, start minimized, keep running)
- All use local `useState` — not persisted
- Not rendered in `SettingsPage.tsx`
- `AppSettings` has no `openAtLogin`, `minimizeToTray`, `startMinimized`, `keepRunning` fields
- `app.setLoginItemSettings()` Electron API never called

### Implementation

**Modify**: `src/shared/types/settings.ts`
- Add to `AppSettings`:
  - `openAtLogin?: boolean`
  - `minimizeToTray?: boolean`
  - `startMinimized?: boolean`
  - `keepRunning?: boolean`

**Modify**: `src/shared/ipc-contract.ts`
- Add `app.setOpenAtLogin` channel: `{ enabled: boolean }` → `{ success: boolean }`
- Add `app.getOpenAtLogin` channel: `void` → `{ enabled: boolean }`

**Modify**: `src/main/ipc/handlers/app-handlers.ts`
- Add handler for `app.setOpenAtLogin` → calls `app.setLoginItemSettings({ openAtLogin: value })`
- Add handler for `app.getOpenAtLogin` → calls `app.getLoginItemSettings()`
- Also persist to settings service for the other background toggles

**Modify**: `src/renderer/features/settings/components/BackgroundSettings.tsx`
- Add "Launch at system startup" toggle
- Load initial values from settings via `useSettings()` hook (not local state)
- Save calls appropriate IPC channels
- For `openAtLogin`: call `app.setOpenAtLogin` IPC
- For other toggles: call `settings.update` with the field

**Modify**: `src/renderer/features/settings/components/SettingsPage.tsx`
- Import and render `<BackgroundSettings />` section (after Appearance, before Profiles)

**Modify**: `src/main/index.ts`
- On app ready, read settings for `startMinimized` → if true, don't show window initially
- Read `minimizeToTray` → wire into window close handler
- Read `keepRunning` → wire into app quit behavior

### Acceptance Criteria
- [ ] BackgroundSettings section visible in Settings page
- [ ] "Launch at system startup" toggle sets system login item
- [ ] Toggle state persists across app restart
- [ ] Other toggles (minimize to tray, start minimized, keep running) persist and function
- [ ] Works on Windows (tested platform)
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run lint` passes

### Files
| Action | Path |
|--------|------|
| MODIFY | `src/shared/types/settings.ts` |
| MODIFY | `src/shared/ipc-contract.ts` |
| MODIFY | `src/main/ipc/handlers/app-handlers.ts` |
| MODIFY | `src/renderer/features/settings/components/BackgroundSettings.tsx` |
| MODIFY | `src/renderer/features/settings/components/SettingsPage.tsx` |
| MODIFY | `src/main/index.ts` |

---

## Item 34: Database Migration Versioning (Hub)

### Problem
Hub database schema is applied as a raw `db.exec(schema.sql)` on every startup. No version tracking, no migration history, no safe path for schema changes.

### Current State
- `hub/src/db/schema.sql` defines 9 tables with `CREATE TABLE IF NOT EXISTS`
- `hub/src/db/database.ts` runs `readFileSync(schema.sql)` → `db.exec(schema)` on init
- No `schema_version` or `migrations` table
- No way to add columns or alter tables without data loss risk

### Implementation

**Create**: `hub/src/db/migrations/` directory
- `001_initial_schema.sql` — the current schema.sql content (baseline)

**Create**: `hub/src/db/migration-runner.ts`
- Reads migration files from `migrations/` directory
- Creates `schema_version` table if not exists: `(version INT PRIMARY KEY, name TEXT, applied_at TEXT)`
- Gets current version from `schema_version`
- Applies all pending migrations in order
- Wraps each migration in a transaction for atomicity
- Logs applied migrations

**Modify**: `hub/src/db/database.ts`
- Replace `runMigrations()` call with `runMigrationRunner(db)` from migration-runner
- Remove the old `readFileSync(schema.sql)` approach

**Keep**: `hub/src/db/schema.sql`
- Keep for reference/documentation, but mark as "see migrations/" at the top

### Migration Runner Design
```typescript
interface Migration {
  version: number;
  name: string;
  sql: string;
}

function runMigrationRunner(db: Database): void {
  // 1. Create schema_version table if not exists
  // 2. Read current version (SELECT MAX(version))
  // 3. Read all .sql files from migrations/ directory
  // 4. Sort by version number (filename prefix)
  // 5. Apply each pending migration in a transaction
  // 6. Insert into schema_version after each success
}
```

### Acceptance Criteria
- [ ] Fresh database: all migrations applied, schema_version table populated
- [ ] Existing database: only new migrations applied, data preserved
- [ ] Migration failure: transaction rolls back, no partial state
- [ ] Hub server starts and runs cleanly
- [ ] Current schema is exactly reproduced by running migration 001
- [ ] `npx tsc --noEmit` passes (hub project)
- [ ] Hub tests pass (if any)

### Files
| Action | Path |
|--------|------|
| CREATE | `hub/src/db/migrations/001_initial_schema.sql` |
| CREATE | `hub/src/db/migration-runner.ts` |
| MODIFY | `hub/src/db/database.ts` |
| MODIFY | `hub/src/db/schema.sql` (add header note) |

---

## Item 35: Electron Auto-Updater Wiring

### Problem
IPC events `event:app.updateAvailable` and `event:app.updateDownloaded` are defined in the contract but nothing emits them. The `electron-updater` dependency was previously removed as unused.

### Current State
- `event:app.updateAvailable` and `event:app.updateDownloaded` defined in IPC contract (stubs)
- `electron-updater` was removed from package.json (marked as unused during P6 cleanup)
- No auto-updater service, no handlers, no UI

### Implementation

**Install**: `electron-updater` package
```bash
npm install electron-updater
```

**Create**: `src/main/services/app/app-update-service.ts`
- Wraps `electron-updater`'s `autoUpdater`
- `checkForUpdates()` → triggers update check
- `downloadUpdate()` → downloads available update
- `quitAndInstall()` → applies update and restarts
- Emits IPC events: `event:app.updateAvailable`, `event:app.updateDownloaded`
- Configurable: auto-check on startup (with 30s delay), periodic check interval

**Create**: `src/main/ipc/handlers/app-update-handlers.ts`
- `app.checkForUpdates` → calls update service
- `app.downloadUpdate` → starts download
- `app.quitAndInstall` → applies and restarts
- `app.getUpdateStatus` → returns current update state

**Modify**: `src/shared/ipc-contract.ts`
- Add invoke channels: `app.checkForUpdates`, `app.downloadUpdate`, `app.quitAndInstall`, `app.getUpdateStatus`
- Verify event channels already exist (they do)

**Create**: `src/renderer/shared/components/AppUpdateNotification.tsx`
- Listens for `event:app.updateAvailable` → shows "Update available" notification
- Shows version number and "Download" button
- After download completes (`event:app.updateDownloaded`): shows "Restart to update" button
- Dismissible

**Modify**: `src/renderer/app/layouts/RootLayout.tsx`
- Add `<AppUpdateNotification />` component

**Modify**: `src/main/index.ts`
- Create update service on app ready (with 30s startup delay)
- Register update handlers

**Modify**: `src/main/ipc/index.ts`
- Register update handler file

### Acceptance Criteria
- [ ] App checks for updates 30s after startup
- [ ] "Update available" notification appears when update exists
- [ ] Download button triggers update download
- [ ] "Restart to update" button appears after download
- [ ] Graceful handling when no update available (silent, no UI)
- [ ] Works offline (no crash, no error toast)
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run lint` passes
- [ ] `npm run build` passes (electron-updater compatible with build)

### Files
| Action | Path |
|--------|------|
| CREATE | `src/main/services/app/app-update-service.ts` |
| CREATE | `src/main/ipc/handlers/app-update-handlers.ts` |
| CREATE | `src/renderer/shared/components/AppUpdateNotification.tsx` |
| MODIFY | `package.json` (add `electron-updater`) |
| MODIFY | `src/shared/ipc-contract.ts` |
| MODIFY | `src/main/index.ts` |
| MODIFY | `src/main/ipc/index.ts` |
| MODIFY | `src/renderer/app/layouts/RootLayout.tsx` |

---

## Item 36: Remove Withings Dead Code

### Problem
Withings OAuth provider config exists but no actual Withings API calls or sync logic are implemented. It's dead code.

### Current State
- `src/main/auth/providers/withings.ts` — OAuth config stub (empty clientId/clientSecret)
- `src/main/services/fitness/fitness-service.ts` — References `source === 'withings'` in deduplication
- `src/renderer/features/settings/components/OAuthProviderSettings.tsx` — Shows Withings card
- `src/shared/types/fitness.ts` — `MeasurementSource` type includes `'withings'`
- `src/main/index.ts` — Imports Withings config
- Multiple doc/agent files reference Withings

### Implementation

**Delete**: `src/main/auth/providers/withings.ts`

**Modify**: `src/main/index.ts`
- Remove import of `WITHINGS_OAUTH_CONFIG`
- Remove Withings from provider registration

**Modify**: `src/renderer/features/settings/components/OAuthProviderSettings.tsx`
- Remove Withings from the `PROVIDER_CONFIG` array

**Modify**: `src/shared/types/fitness.ts`
- Remove `'withings'` from `MeasurementSource` type
- Simplify to only real sources: `'manual'` (and any other active sources)

**Modify**: `src/main/services/fitness/fitness-service.ts`
- Remove Withings-specific deduplication logic
- Simplify the measurement filtering

**Modify**: Agent/doc references (if they cause lint/build failures)
- `.claude/agents/fitness-engineer.md` — remove Withings mentions
- `.claude/agents/oauth-engineer.md` — remove Withings mentions

### Acceptance Criteria
- [ ] No references to "withings" in runtime source code (`src/`)
- [ ] Withings card no longer appears in OAuth Provider Settings
- [ ] `MeasurementSource` type only includes valid, active sources
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run lint` passes
- [ ] `npm run build` passes

### Files
| Action | Path |
|--------|------|
| DELETE | `src/main/auth/providers/withings.ts` |
| MODIFY | `src/main/index.ts` |
| MODIFY | `src/renderer/features/settings/components/OAuthProviderSettings.tsx` |
| MODIFY | `src/shared/types/fitness.ts` |
| MODIFY | `src/main/services/fitness/fitness-service.ts` |

---

## Item 37: Background Manager Dead Code Cleanup

### Problem
`BackgroundManager` and `Scheduler` are stub code that's never instantiated. Alert checking is already handled by `AlertService.startChecking()`.

### Current State
- `background-manager.ts` — Has `handleAlertCheck()` and `handleHealthCheck()` that only log
- `scheduler.ts` — Generic interval scheduler (working code, but no consumer)
- Neither is instantiated in `src/main/index.ts`
- `AlertService` already polls for alerts every 60 seconds independently

### Implementation

**Delete**: `src/main/services/background/background-manager.ts`
**Delete**: `src/main/services/background/scheduler.ts`

**Verify**: `src/main/index.ts` — confirm no BackgroundManager references (remove if found)

**Verify**: No other imports reference these files (grep to confirm)

### Acceptance Criteria
- [ ] `background-manager.ts` deleted
- [ ] `scheduler.ts` deleted
- [ ] No import references to deleted files
- [ ] Alert checking still works (AlertService unaffected)
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run lint` passes

### Files
| Action | Path |
|--------|------|
| DELETE | `src/main/services/background/background-manager.ts` |
| DELETE | `src/main/services/background/scheduler.ts` |
| VERIFY | `src/main/index.ts` (remove any references if found) |

---

## Task Decomposition & Agent Assignment

### Wave 1: Cleanup (No Dependencies, Can Run in Parallel)

| Task | Agent | Scope | Blocked By |
|------|-------|-------|------------|
| T1: Remove Withings dead code | cleanup-eng | Item 36 | None |
| T2: Remove background-manager dead code | cleanup-eng | Item 37 | None |

**Note**: T1 and T2 can be handled by the same agent since they're both small deletions with no overlap.

### Wave 2: Type & Contract Layer (Foundation for Waves 3-4)

| Task | Agent | Scope | Blocked By |
|------|-------|-------|------------|
| T3: Add settings types + IPC channels for P5 features | schema-eng | Items 31-33, 35 | None |

This task adds all new types and IPC contract channels needed by items 31, 32, 33, and 35. All subsequent service/UI work depends on these types being defined first.

### Wave 3: Services & Handlers (Can Parallelize)

| Task | Agent | Scope | Blocked By |
|------|-------|-------|------------|
| T4: Hub connection indicator (service + UI) | indicator-eng | Item 31 | T3 |
| T5: Hotkey persistence + re-registration | hotkey-eng | Item 32 | T3 |
| T6: App startup + background settings wiring | startup-eng | Item 33 | T3 |
| T7: Auto-updater service + UI | updater-eng | Item 35 | T3 |
| T8: Hub database migration system | migration-eng | Item 34 | None |

**Note**: T8 (Hub migrations) has no dependency on T3 since it's Hub-server-only code.

### Wave 4: Integration & Settings Page Assembly

| Task | Agent | Scope | Blocked By |
|------|-------|-------|------------|
| T9: Wire all new sections into SettingsPage | settings-eng | Items 32, 33 | T5, T6 |

**Note**: T4, T7 integrate into Sidebar/RootLayout (not SettingsPage), so they complete independently.

### Wave 5: Documentation

| Task | Agent | Scope | Blocked By |
|------|-------|-------|------------|
| T10: Update all documentation | doc-eng | All items | T1-T9 |

---

## Dependency Graph

```
T1 (Withings cleanup) ─────────────────────────────────────────┐
T2 (BG manager cleanup) ───────────────────────────────────────┤
                                                                │
T3 (Types + IPC contract) ─────┬──────┬──────┬──────┐          │
                               │      │      │      │          │
                               ▼      ▼      ▼      ▼          │
                           T4(Hub) T5(Keys) T6(Start) T7(Update)│
                                   │      │                    │
                                   ▼      ▼                    │
                               T9 (SettingsPage assembly)      │
                                          │                    │
T8 (Hub migrations) ─────────────────────┤                    │
                                          │                    │
                                          ▼                    │
                               T10 (Documentation) ◀──────────┘
```

---

## Out-of-Scope Issues to Address

During scoping, these issues were identified as adjacent problems worth fixing in the same pass:

1. **HotkeySettings.tsx calls `updateSettings.mutate({ hotkeys: ... })` but `hotkeys` isn't in `AppSettings`** — Fixed by T3 (adding the type) and T5 (wiring the backend)

2. **BackgroundSettings.tsx uses local state instead of persisted settings** — Fixed by T6 (wiring to real settings)

3. **BackgroundSettings.tsx is never rendered in SettingsPage** — Fixed by T9 (settings page assembly)

4. **HotkeySettings.tsx is never rendered in SettingsPage** — Fixed by T9 (settings page assembly)

5. **SettingsPage has no "About" version display from IPC** — Can fix in T9 (call `app.getVersion` and display)

---

## Success Criteria (Full P5)

- [ ] All 7 audit items implemented or cleaned up
- [ ] Hub connection indicator visible in sidebar
- [ ] Hotkeys configurable and persisted
- [ ] App launch at startup toggleable
- [ ] Hub database has migration versioning
- [ ] Auto-updater wired and emitting events
- [ ] Zero Withings references in runtime code
- [ ] Zero dead code in background-manager
- [ ] SettingsPage shows all settings sections
- [ ] `npm run lint` — 0 violations
- [ ] `npx tsc --noEmit` — 0 errors
- [ ] `npm run build` — passes clean
- [ ] All new features testable with only API keys + Claude auth configured
